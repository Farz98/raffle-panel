<!DOCTYPE html>
<html>

<head>
    <title>Raffle Admin Dashboard</title>
    <meta charset="UTF-8" />

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial;
            background: #f4f6f8;
            padding: 20px;
        }

        .cards {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        table {
            width: 100%;
            background: #fff;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 6px;
            border-bottom: 1px solid #ddd;
            text-align: center;
            font-size: 13px;
        }

        canvas {
            background: #fff;
            padding: 10px;
            margin-top: 20px;
            max-height: 250px;
        }

        input,
        select,
        button {
            padding: 6px;
            margin: 4px;
        }

        h3 {
            margin-top: 30px;
        }

        /* Loader */
        #loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .panel {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        button.small {
            padding: 4px 8px;
            font-size: 12px;
        }
    </style>
</head>

<body>

    <h1>Raffle Admin Dashboard</h1>

    <!-- Loader -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div id="app">

        <!-- SUMMARY -->
        <div class="cards">
            <div class="card">
                <h2 id="todayCount">0</h2>
                <p>Today</p>
            </div>
            <div class="card">
                <h2 id="weekCount">0</h2>
                <p>Last 7 days</p>
            </div>
            <div class="card">
                <h2 id="agentCount">0</h2>
                <p>Active Agents</p>
            </div>
            <div class="card">
                <h2 id="userCount">0</h2>
                <p>Total Users</p>
            </div>
        </div>

        <!-- ===================== ADD AGENT ===================== -->
        <div class="panel">
            <h3>âž• Add Agent</h3>
            <input id="agentName" placeholder="Agent Name">
            <input id="agentEmail" placeholder="Email">
            <input id="agentPhone" placeholder="Phone">
            <input id="agentPassword" type="password" placeholder="Password">
            <button onclick="addAgent()">Create Agent</button>
        </div>


        <!-- ===================== USER LIST ===================== -->
        <div class="panel">
            <input id="userSearch" placeholder="Search name / email / phone" />
            <button onclick="searchUsers()">Search</button>
            <h3>ðŸ‘¤ Users</h3>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userTable"></tbody>
            </table>

            <div style="margin-top:10px;text-align:center;">
                <button onclick="prevUserPage()">Prev</button>
                <span id="userPageInfo"></span>
                <button onclick="nextUserPage()">Next</button>
            </div>
        </div>


        <!-- ===================== AGENT LIST ===================== -->
        <div class="panel">
            <h3>ðŸ‘¥ Agents</h3>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="agentTable"></tbody>
            </table>

            <div style="margin-top:10px;text-align:center;">
                <button onclick="prevAgentPage()">Prev</button>
                <span id="agentPageInfo"></span>
                <button onclick="nextAgentPage()">Next</button>
            </div>
        </div>

        <!-- REPORTS -->
        <h3>Reports</h3>
        <label>Agent:</label>
        <select id="agentSelect">
            <option value="">All</option>
        </select>
        <label>User Phone:</label>
        <input type="text" id="userPhone" placeholder="Enter phone number">
        <label>Start:</label><input type="date" id="startDate">
        <label>End:</label><input type="date" id="endDate">
        <label>Winning Digit:</label><input id="winningDigit" maxlength="3" placeholder="Optional">
        <button onclick="filterEntries()">Generate</button>
        <button onclick="exportExcel()">Export Excel</button>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Raffle ID</th>
                    <th>Agent</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Digits</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="entryTable"></tbody>
        </table>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getFirestore, collection, getCountFromServer, query, where, getDocs, setDoc, orderBy, doc, deleteDoc, updateDoc, serverTimestamp, limit, startAfter, or } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

        // ---------------- CONFIG ----------------
        const firebaseConfig = {
            apiKey: "AIzaSyDowv99kR6eCENVMaA1cyPAhB-uioHTKdo",
            authDomain: "raffle-fd694.firebaseapp.com",
            projectId: "raffle-fd694"
        };

        // Initialize
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ---------------- LOADER ----------------
        window.showLoader = () => document.getElementById('loader').style.display = 'flex';
        window.hideLoader = () => document.getElementById('loader').style.display = 'none';

        // ---------------- GLOBALS ----------------
        let adminUser = JSON.parse(localStorage.getItem("adminUser"));
        if (!adminUser) {
            localStorage.removeItem("adminUser");
            window.location.href = "index.html";
        }

        let reportData = [];
        let userDocs = [], userPage = 0;
        const userPageSize = 5;
        let agentDocs = [], agentPage = 0;
        const pageSize = 5;

        // ---------------- UAE TIME HELPERS ----------------
        function uaeStartOfDay(dateInput) {
            const d = new Date(dateInput);
            return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 0 - 4, 0, 0, 0));
        }

        function uaeEndOfDay(dateInput) {
            const d = new Date(dateInput);
            return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 23 - 4, 59, 59, 999));
        }

        function uaeDaysAgo(days) {
            const d = new Date();
            d.setDate(d.getDate() - days);
            return d;
        }

        function generateOtherPermutations(digits) {
            const result = new Set();
            function permute(chars, l, r) {
                if (l === r) { result.add(chars.join("")); }
                else {
                    for (let i = l; i <= r; i++) {
                        [chars[l], chars[i]] = [chars[i], chars[l]];
                        permute(chars, l + 1, r);
                        [chars[l], chars[i]] = [chars[i], chars[l]];
                    }
                }
            }
            permute(digits.split(""), 0, digits.length - 1);
            result.delete(digits);
            result.delete(digits.split("").reverse().join(""));
            return Array.from(result);
        }

        window.searchUsers = async function (page = 1) {
            const value = document.getElementById("userSearch").value.trim();
            userDocs = null;
            showLoader();

            let q = query(
                collection(db, "users"),
                orderBy("createdAt", "desc"),
                or(
                    where("name", "==", value),
                    where("phone", "==", value),
                    where("email", "==", value),
                ),
                limit(userPageSize)
            );

            if (lastUserDoc && page > 1) {
                q = query(
                    collection(db, "users"),
                    orderBy("createdAt", "desc"),
                    startAfter(lastUserDoc),
                    or(
                        where("name", "==", value),
                        where("phone", "==", value),
                        where("email", "==", value),
                    ),
                    limit(userPageSize)
                );
            }

            const snap = await getDocs(q);
            userDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));

            // Track the last document for the next page
            lastUserDoc = snap.docs[snap.docs.length - 1];

            renderUserPage();
            hideLoader();

        };

        // ---------------- DASHBOARD COUNTS ----------------
        window.loadDashboard = async function () {
            try {
                showLoader();

                // Today raffle count
                const todayStart = uaeStartOfDay(new Date());
                const todayEnd = uaeEndOfDay(new Date());
                const todaySnap = await getCountFromServer(query(
                    collection(db, "raffles"),
                    where("createdAt", ">=", todayStart),
                    where("createdAt", "<=", todayEnd)
                ));
                document.getElementById("todayCount").innerText = todaySnap.data().count;

                // Last 7 days raffle count
                const weekStart = uaeStartOfDay(uaeDaysAgo(6));
                const weekEnd = todayEnd;
                const weekSnap = await getCountFromServer(query(
                    collection(db, "raffles"),
                    where("createdAt", ">=", weekStart),
                    where("createdAt", "<=", weekEnd)
                ));
                document.getElementById("weekCount").innerText = weekSnap.data().count;

                // Agents count
                const agentSnap = await getCountFromServer(collection(db, "agents"));
                document.getElementById("agentCount").innerText = agentSnap.data().count;

                // Users count
                const userSnap = await getCountFromServer(collection(db, "users"));
                document.getElementById("userCount").innerText = userSnap.data().count;

                // Load tables and stats
                await loadAgents();
                await loadAgentTable();
                await loadUserTable();
                await liveStats();

            } catch (err) {
                console.error("Error loading dashboard:", err);
            } finally {
                hideLoader();
            }
        }

        // ---------------- AGENT DROPDOWN ----------------
        window.loadAgents = async function () {
            const snap = await getDocs(collection(db, "agents"));
            agentDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));

            const agentSelect = document.getElementById("agentSelect");
            agentSelect.innerHTML = '<option value="">All</option>';
            agentDocs.forEach(a => {
                const opt = document.createElement("option");
                opt.value = a.id;
                opt.text = a.name;
                agentSelect.appendChild(opt);
            });
        }

        // ---------------- AGENT TABLE ----------------
        window.loadAgentTable = async function () {
            const snap = await getDocs(query(collection(db, "agents"), orderBy("createdAt", "desc")));
            agentDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            agentPage = 0;
            renderAgentPage();
        }

        window.renderAgentPage = function () {
            const agentTable = document.getElementById("agentTable");
            agentTable.innerHTML = "";
            const start = agentPage * pageSize;
            const end = start + pageSize;
            agentDocs.slice(start, end).forEach((a, i) => {
                agentTable.innerHTML += `<tr>
        <td>${start + i + 1}</td>
        <td>${a.name}</td>
        <td>${a.email || ""}</td>
        <td>${a.phone || ""}</td>
        <td>${a.isActive === false ? "Inactive" : "Active"}</td>
        <td>
          <button class="small" onclick="resetPassword('${a.email}')">Reset</button>
          <button class="small" onclick="toggleAgent('${a.id}', ${a.isActive !== false})">
            ${a.isActive === false ? "Enable" : "Disable"}
          </button>
        </td>
      </tr>`;
            });
            document.getElementById("agentPageInfo").innerText = `Page ${agentPage + 1} / ${Math.ceil(agentDocs.length / pageSize)}`;
        }

        window.nextAgentPage = function () {
            if ((agentPage + 1) * pageSize < agentDocs.length) { agentPage++; renderAgentPage(); }
        }
        window.prevAgentPage = function () {
            if (agentPage > 0) { agentPage--; renderAgentPage(); }
        }

        window.resetPassword = function (email) {
            sendPasswordResetEmail(auth, email).then(() => alert("Password reset email sent"));
        }

        window.toggleAgent = async function (agentId, currentlyActive) {
            if (!confirm(`${currentlyActive ? "Disable" : "Enable"} this agent?`)) return;
            showLoader();
            await updateDoc(doc(db, "agents", agentId), { isActive: !currentlyActive });
            await loadAgents();
            await loadAgentTable();
            hideLoader();
            alert(`Agent ${currentlyActive ? "Disabled" : "Enabled"} successfully`);
        }
        let lastUserDoc = null;


        // ---------------- USER TABLE ----------------
        window.loadUserTable = async function (page = 1) {
            showLoader();

            let q = query(
                collection(db, "users"),
                orderBy("createdAt", "desc"),
                limit(userPageSize)
            );

            if (lastUserDoc && page > 1) {
                q = query(
                    collection(db, "users"),
                    orderBy("createdAt", "desc"),
                    startAfter(lastUserDoc),
                    limit(userPageSize)
                );
            }

            const snap = await getDocs(q);
            userDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));

            // Track the last document for the next page
            lastUserDoc = snap.docs[snap.docs.length - 1];

            renderUserPage();
            hideLoader();
        }

        window.renderUserPage = function () {
            const userTable = document.getElementById("userTable");
            userTable.innerHTML = "";

            userDocs.forEach((u, i) => {
                userTable.innerHTML += `<tr>
            <td>${i + 1}</td>
            <td>${u.name || ""}</td>
            <td>${u.email || ""}</td>
            <td>${u.phone || ""}</td>
            <td><button class="small" onclick="deleteUser('${u.id}')">Delete</button></td>
        </tr>`;
            });
        }
        let currentUserPage = 1;
        window.nextUserPage = function () {
            currentUserPage++;
            loadUserTable(currentUserPage);
        }
        window.prevUserPage = function () {
            if (currentUserPage > 1) {
                currentUserPage--;
                // Reset lastUserDoc for proper startAfter
                // Optionally, you can track last doc of previous page
                loadUserTable(currentUserPage);
            }
        }

        window.deleteUser = async function (id) {
            if (!confirm("Delete this user?")) return;
            await deleteDoc(doc(db, "users", id));
            await loadUserTable();
        }

        window.addAgent = async function () {

            const name = agentName.value.trim();
            const email = agentEmail.value.trim();
            const phone = agentPhone.value.trim();
            const password = agentPassword.value.trim();

            if (!name || !email || !password) {
                alert("Name, Email and Password required");
                return;
            }

            showLoader();

            try {
                // ðŸ”¹ Secondary Firebase App (same as your old code)
                const secondaryApp = initializeApp(firebaseConfig, "Secondary");
                const secondaryAuth = getAuth(secondaryApp);

                // ðŸ”¹ Create Auth User
                const cred = await createUserWithEmailAndPassword(
                    secondaryAuth,
                    email,
                    password
                );

                // ðŸ”¹ Write to Firestore
                await setDoc(doc(db, "agents", cred.user.uid), {
                    id: cred.user.uid,
                    name,
                    email,
                    phone,
                    role: "agent",
                    isActive: true,
                    createdAt: serverTimestamp()
                });

                // ðŸ”¹ Cleanup secondary app
                await secondaryAuth.signOut();

                // ðŸ”¹ Clear form
                agentName.value = "";
                agentEmail.value = "";
                agentPhone.value = "";
                agentPassword.value = "";

                // ðŸ”¹ Refresh UI
                await loadAgents();
                await loadAgentTable();

                alert("Agent created successfully");

            } catch (e) {
                alert(e.message);
            }

            hideLoader();
        };

        // ---------------- LIVE STATS ----------------
        window.liveStats = async function () {
            const todayStart = uaeStartOfDay(new Date());
            const todayEnd = uaeEndOfDay(new Date());
            const snap = await getCountFromServer(query(
                collection(db, "raffles"),
                where("createdAt", ">=", todayStart),
                where("createdAt", "<=", todayEnd)
            ));
            const today = snap.data().count;
            document.getElementById("todayCount").innerText = today;
        }


        // ---------------- FILTER ENTRIES ----------------
        window.filterEntries = async function () {
            showLoader();
            try {
                const agent = document.getElementById("agentSelect").value;
                const userPhone = document.getElementById("userPhone").value.trim();
                const startVal = document.getElementById("startDate").value;
                const endVal = document.getElementById("endDate").value;

                if (!startVal || !endVal) { alert("Select BOTH dates"); return; }

                const start = uaeStartOfDay(new Date(startVal));
                const end = uaeEndOfDay(new Date(endVal));
                let ref = collection(db, "raffles");

                let q = query(ref);
                if (agent) q = query(q, where("agentId", "==", agent));
                if (userPhone) q = query(q, where("phone", "==", userPhone));
                q = query(q, where("createdAt", ">=", start), where("createdAt", "<=", end));

                const snap = await getDocs(q);
                reportData = snap.docs.map(d => d.data());
                renderPreview();

            } catch (err) { console.error(err); alert("Error loading entries"); }
            finally { hideLoader(); }
        }

        // ---------------- RENDER PREVIEW ----------------
        window.renderPreview = function () {
            const winningDigitVal = winningDigit.value.trim();
            entryTable.innerHTML = "";
            let serial = 1;

            if (!winningDigitVal) {
                Object.values(reportData)
                    .sort((a, b) => a.raffleId.localeCompare(b.raffleId))
                    .forEach(row => {
                        const date = row.createdAt?.toDate?.() || new Date();
                        entryTable.innerHTML += `<tr>
        <td>${serial++}</td>
        <td>${row.raffleId}</td>
        <td>${row.agentName}</td>
        <td>${row.name || ""}</td>
        <td>${row.phone || ""}</td>
        <td>${row.digits || ""}</td>
        <td>${date.toLocaleString()}</td>
      </tr>`;
                    });
            } else {
                const exact = [], reverse = [], others = [];
                const rev = winningDigitVal.split("").reverse().join("");
                const otherPerms = generateOtherPermutations(winningDigitVal);

                Object.values(reportData)
                    .sort((a, b) => a.raffleId.localeCompare(b.raffleId))
                    .forEach(row => {
                        const d = row.digits;
                        if (d === winningDigitVal) exact.push(row);
                        else if (d === rev) reverse.push(row);
                        else if (otherPerms.includes(d)) others.push(row);
                    });

                function renderSection(title, data) {
                    if (data.length === 0) return;
                    entryTable.innerHTML += `<tr><td colspan="8" style="background:#eee;font-weight:bold;">${title}</td></tr>`;
                    data.forEach(row => {
                        const date = row.createdAt?.toDate?.() || new Date();
                        entryTable.innerHTML += `<tr>
          <td>${serial++}</td>
          <td>${row.raffleId}</td>
          <td>${row.drawId}</td>
          <td>${row.agentName}</td>
          <td>${row.name || ""}</td>
          <td>${row.phone || ""}</td>
          <td>${row.digits || ""}</td>
          <td>${date.toLocaleString()}</td>
        </tr>`;
                    });
                }

                renderSection("Winner (Exact Match)", exact);
                renderSection("Runner-Up (Reverse)", reverse);
                renderSection("Other Combinations", others);
            }
        }

        // ---------------- EXPORT EXCEL ----------------
        window.exportExcel = function () {
            showLoader();
            try {
                const winningDigitVal = winningDigit.value.trim();
                const wb = XLSX.utils.book_new();
                let serial = 1;
                if (winningDigitVal) {
                    const exact = [], reverse = [], others = [];
                    const rev = winningDigitVal.split("").reverse().join("");
                    const otherPerms = generateOtherPermutations(winningDigitVal);

                    Object.values(reportData)
                        .sort((a, b) => a.raffleId.localeCompare(b.raffleId))
                        .forEach(row => {
                            const d = row.digits;
                            const obj = { Serial: serial++, ...row };
                            if (d === winningDigitVal) exact.push(obj);
                            else if (d === rev) reverse.push(obj);
                            else if (otherPerms.includes(d)) others.push(obj);
                        });

                    if (exact.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exact), "Winner");
                    if (reverse.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(reverse), "Runner-Up");
                    if (others.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(others), "Other Combinations");
                } else {
                    const allData = Object.values(reportData).map((row) => ({ Serial: serial++, ...row }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allData), "All Entries");
                }
                XLSX.writeFile(wb, "raffle_report.xlsx");
            } catch (e) { console.error(e); alert("Error exporting Excel"); }
            finally { hideLoader(); }
        }

        // ---------------- LOGOUT ----------------
        window.logout = function () {
            signOut(auth).then(() => {
                localStorage.removeItem("adminUser");
                window.location.href = "index.html";
            });
        }

        // ---------------- LOAD DASHBOARD ON PAGE LOAD ----------------
        window.onload = loadDashboard;

    </script>




</body>

</html>